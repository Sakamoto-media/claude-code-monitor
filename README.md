# Claude Code Monitor

複数のTerminal.appタブ/ウィンドウで実行中のClaude Codeセッションを視覚的に監視・操作できるmacOS専用GUIアプリケーションです。

## 機能

### 📊 マルチセッション監視
- 複数のTerminal.appウィンドウ・タブを自動検出
- Claude Codeの実行状態をリアルタイムで表示
  - 🟢 **緑**: 実行中 (`(esc to interrupt`を検出)
  - 🟡 **黄**: 選択待ち (選択肢を検出)
  - ⚫ **グレー**: アイドル状態
- 各セッションの出力をAPI要約で表示（Claude API使用）
- 前回のユーザー指示を除外した正確な要約

### 🖱️ GUI操作
- 縦長のモニタリングウィンドウ（350x800px）
- カード全体クリックでセッション切り替え
- ドラッグ&ドロップでカード並び替え
- スクロール可能な出力表示（最大20,000文字）
- 常に最前面表示

### 🎯 セッション管理
- 初期表示: Window ID順に自動ソート
- ユーザー定義順序: ドラッグ&ドロップで自由に配置
- 新規セッション: 末尾に自動追加
- セッション状態の永続化（表示順序を保持）

## システム要件

- **OS**: macOS 10.14以降
- **Python**: 3.8以降
- **Terminal**: Terminal.app
- **オプション**: Claude API Key（要約機能用）

## インストール

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd 画面操作
```

### 2. 依存関係のインストール

```bash
pip install -r requirements.txt
```

主な依存関係:
- `anthropic`: Claude API（要約機能）
- Python標準ライブラリ（tkinter）

### 3. 権限設定

macOSのセキュリティ設定で以下の権限を許可：

- **アクセシビリティ**: システム設定 → プライバシーとセキュリティ → アクセシビリティ
  - Terminal.appまたはPythonを許可（AppleScript実行用）

### 4. Claude API設定（オプション）

高度な要約機能を使用する場合、`api_config.json`を作成：

```json
{
  "anthropic_api_key": "your-api-key-here",
  "model": "claude-sonnet-4-5-20250929",
  "max_tokens": 200,
  "temperature": 0.7,
  "summary_instructions": "以下のClaude Codeセッションの出力を、10秒で読める程度（約150文字）に要約してください。重要なポイント、エラー、進捗状況を含めてください。"
}
```

API Keyの取得: [Anthropic Console](https://console.anthropic.com/)

## 使い方

### 起動

```bash
python main.py
```

または実行権限を付与して：

```bash
chmod +x main.py
./main.py
```

### 基本操作

1. **アプリケーション起動**: 縦長のモニタリングウィンドウが表示
2. **セッション確認**: 各Terminal.appタブが自動検出され、カード表示
3. **クリックで切り替え**: カードをクリックして対応するセッションに切り替え
4. **ドラッグ&ドロップ**: カードをドラッグして表示順序を変更

### GUI要素

#### セッションカード
- **タイトル**: セッション名（タブ名）
- **状態枠**: 色で実行状態を表示
  - 緑: Claudeが処理中
  - 黄: ユーザーの選択待ち
  - グレー: アイドル状態
- **要約**: Claudeの最新応答を要約表示（スクロール可能）
- **ステータス**: `Status: active/waiting/idle`

#### 操作
- **クリック**: セッションに切り替え（バックグラウンドモード）
- **ドラッグ**: カードを上下に移動して並び替え
- **スクロール**: マウスホイールでリスト全体をスクロール

## アーキテクチャ

```
main.py                    # メインコントローラー
├── terminal_monitor.py    # Terminal.app監視・制御
├── gui.py                 # Tkinter GUI
├── claude_parser.py       # Claude Code出力解析・要約
└── config.py              # 設定ファイル
```

### 主要モジュール

#### main.py
- アプリケーションのメインループ
- セッション状態の永続化（session_map）
- 表示順序の管理（display_order）
- 1秒ごとの自動更新
- ドラッグ中の更新一時停止
- 強制更新メカニズム

#### terminal_monitor.py
- AppleScriptでTerminal.appの情報を取得
- タブ/ウィンドウの切り替え
- セッション内容の読み取り（最新1000行）
- 状態判定ロジック:
  - 最下部10行を分析
  - ユーザー入力エリアを除外
  - 選択肢検出（"1. "と"2. "）
  - アクティブキーワード検出（"(esc to interrupt"）

#### gui.py
- Tkinterで縦長モニタリングウィンドウを構築
- セッションカードの表示と更新
- ドラッグ&ドロップ処理
- スレッドセーフなGUI更新（queue使用）
- カード再利用による効率的な更新

#### claude_parser.py
- Claude Codeの出力を解析
- Claude APIによる要約生成
- 前回のユーザー指示を除外
- 現在のユーザー入力エリアを除外
- 2段階フィルタリングで正確な範囲抽出

## 設定のカスタマイズ

### config.py

```python
# ウィンドウサイズ
WINDOW_WIDTH = 350
WINDOW_HEIGHT = 800

# 更新間隔（ミリ秒）
UPDATE_INTERVAL = 1000  # 1秒ごとに更新

# 色設定
COLORS = {
    "bg": "#1e1e1e",       # 背景色
    "fg": "#ffffff",       # テキスト色
    "active": "#00ff00",   # 実行中（緑）
    "waiting": "#ffff00",  # 選択待ち（黄）
    "idle": "#3a3a3a",     # アイドル（グレー）
}
```

## トラブルシューティング

### Terminal.appのタブが検出されない

1. Terminal.appが起動しているか確認
2. AppleScriptの権限を確認（システム設定 → アクセシビリティ）
3. Terminal.appのタブが実際に開いているか確認

### セッション切り替えができない

1. アクセシビリティ権限を確認
2. Terminal.appが応答しているか確認
3. Claude Codeが実行中か確認

### 要約が生成されない

1. `api_config.json`が正しく設定されているか確認
2. API Keyが有効か確認
3. インターネット接続を確認

### ドラッグ&ドロップが反応しない

1. カードの外枠をドラッグ（5px以上移動で反応）
2. 更新中はドラッグを一時停止
3. ドロップ後100msで自動更新

## 制限事項

- **macOS専用**: Terminal.app、AppleScript依存
- **Terminal.app専用**: iTerm2など他のターミナルエミュレータには非対応
- **Claude Code専用**: 一般的なターミナルセッションには対応していません
- **ポーリング方式**: 1秒ごとに更新（イベント駆動ではない）

## 技術詳細

### 状態判定アルゴリズム

1. **前処理**:
   - Terminal.appから最新1000行を取得
   - ユーザー入力エリア（区切り線で囲まれた部分）を除外

2. **判定**（優先順位順）:
   1. 選択肢検出: 最後の区切り線の下に"1. "と"2. "が存在 → **waiting**
   2. アクティブキーワード: 最下部10行に"(esc to interrupt" → **active**
   3. それ以外 → **idle**

### 要約生成アルゴリズム

1. 現在のユーザー入力エリアを削除（区切り線ペアの検出）
2. 前回のユーザー指示を削除（`>`で始まる段落を検索）
3. Claudeの最新応答のみをClaude APIに送信
4. 約150文字に要約

### スレッドセーフ設計

- メインスレッド: GUI更新、イベント処理
- バックグラウンドスレッド: セッション監視、状態更新
- 通信: `queue.Queue`でスレッド間データ受け渡し
- 衝突回避: ドラッグ中フラグで更新を一時停止

## 今後の改善予定

- [ ] iTerm2対応
- [ ] リアルタイム監視（ポーリング→イベント駆動）
- [ ] セッション履歴の保存
- [ ] キーボードショートカット
- [ ] テーマ切り替え（ダーク/ライト）
- [ ] 音声入力・読み上げ機能（オプション）

## ライセンス

MIT License

## 貢献

Issue、Pull Requestを歓迎します。

## サポート

問題が発生した場合は、以下の情報を含めてIssueを作成してください：

- macOSのバージョン
- Pythonのバージョン
- Claude Code のバージョン
- エラーメッセージ
- 実行ログ

## クレジット

🤖 Developed with [Claude Code](https://claude.com/claude-code)
